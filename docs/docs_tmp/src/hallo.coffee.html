<!DOCTYPE html><html><head><title>hallo.coffee</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../index.html" class="source"><span class="file_name">README</span></a><a href="../src/hallo.coffee.html" class="source selected"><span class="base_path">src / </span><span class="file_name">hallo.coffee</span></a><a href="../src/plugins/lists.coffee.html" class="source "><span class="base_path">src / plugins / </span><span class="file_name">lists.coffee</span></a><a href="../src/plugins/headings.coffee.html" class="source "><span class="base_path">src / plugins / </span><span class="file_name">headings.coffee</span></a><a href="../src/plugins/overlay.coffee.html" class="source "><span class="base_path">src / plugins / </span><span class="file_name">overlay.coffee</span></a><a href="../src/plugins/toolbarlinebreak.coffee.html" class="source "><span class="base_path">src / plugins / </span><span class="file_name">toolbarlinebreak.coffee</span></a><a href="../src/plugins/image.coffee.html" class="source "><span class="base_path">src / plugins / </span><span class="file_name">image.coffee</span></a><a href="../src/plugins/halloformat.coffee.html" class="source "><span class="base_path">src / plugins / </span><span class="file_name">halloformat.coffee</span></a><a href="../src/plugins/reundo.coffee.html" class="source "><span class="base_path">src / plugins / </span><span class="file_name">reundo.coffee</span></a><a href="../src/plugins/link.coffee.html" class="source "><span class="base_path">src / plugins / </span><span class="file_name">link.coffee</span></a><a href="../src/plugins/justify.coffee.html" class="source "><span class="base_path">src / plugins / </span><span class="file_name">justify.coffee</span></a><a href="../src/widgets/button.coffee.html" class="source "><span class="base_path">src / widgets / </span><span class="file_name">button.coffee</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>hallo.coffee</h1><div class="filepath">src/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div><h1>#</h1>
</td><td class="code"><div class="highlight"><pre><span class="nx">Hallo</span> <span class="o">-</span> <span class="nx">a</span> <span class="nx">rich</span> <span class="nx">text</span> <span class="nx">editing</span> <span class="nx">jQuery</span> <span class="nx">UI</span> <span class="nx">widget</span>
<span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="mi">2011</span> <span class="nx">Henri</span> <span class="nx">Bergius</span><span class="p">,</span> <span class="nx">IKS</span> <span class="nx">Consortium</span>
<span class="nx">Hallo</span> <span class="nx">may</span> <span class="nx">be</span> <span class="nx">freely</span> <span class="nx">distributed</span> <span class="nx">under</span> <span class="nx">the</span> <span class="nx">MIT</span> <span class="nx">license</span></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><h1>#</h1>
</td><td class="code"><div class="highlight"><pre><span class="p">(</span><span class="nf">(jQuery) -&gt;</span></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>Hallo provides a jQuery UI widget <code>hallo</code>. Usage:</p>

<pre><code>jQuery('p').hallo();
</code></pre>

<p>Getting out of the editing state:</p>

<pre><code>jQuery('p').hallo({editable: false});
</code></pre>

<p>When content is in editable state, users can just click on
an editable element in order to start modifying it. This
relies on browser having support for the HTML5 contentEditable
functionality, which means that some mobile browsers are not
supported.</p>

<p>If plugins providing toolbar buttons have been enabled for
Hallo, then a floating editing toolbar will be rendered above
the editable contents when an area is active.</p>

<h2>Options</h2>

<p>Change from floating mode to relative positioning with using
the offset to position the toolbar where you want it:</p>

<p>jQuery('selector').hallo({
      floating: true,
      offset: {
        'x' : 0,
        'y' : 0
      }
   });</p>

<p>Force the toolbar to be shown at all times when a contenteditable
element is focused:</p>

<p>jQuery('selector').hallo({
      showAlways: true
   });</p>

<p>showAlways is false by default</p>

<h2>Events</h2>

<p>The Hallo editor provides several jQuery events that web
applications can use for integration:</p>

<h3>Activated</h3>

<p>When user activates an editable (usually by clicking or tabbing
to an editable element), a <code>halloactivated</code> event will be fired.</p>

<pre><code>jQuery('p').bind('halloactivated', function() {
    console.log("Activated");
});
</code></pre>

<h3>Deactivated</h3>

<p>When user gets out of an editable element, a <code>hallodeactivated</code>
event will be fired.</p>

<pre><code>jQuery('p').bind('hallodeactivated', function() {
    console.log("Deactivated");
});
</code></pre>

<h3>Modified</h3>

<p>When contents in an editable have been modified, a
<code>hallomodified</code> event will be fired.</p>

<pre><code>jQuery('p').bind('hallomodified', function(event, data) {
    console.log("New contents are " + data.content);
});
</code></pre>

<h3>Restored</h3>

<p>When contents are restored through calling .hallo("restoreOriginalContent")
or the user pressing ESC while the cursor is in the editable element,
a 'hallorestored' event will be fired.</p>

<pre><code>jQuery('p').bind('hallorestored', function(event, data) {
    console.log("The thrown contents are " + data.thrown);
    console.log("The restored contents are " + data.content);
});
</code></pre>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">jQuery</span><span class="p">.</span><span class="nx">widget</span> <span class="s2">&quot;IKS.hallo&quot;</span><span class="p">,</span>
        <span class="nv">toolbar: </span><span class="kc">null</span>
        <span class="nv">bound: </span><span class="kc">false</span>
        <span class="nv">originalContent: </span><span class="s2">&quot;&quot;</span>
        <span class="nv">uuid: </span><span class="s2">&quot;&quot;</span>
        <span class="nv">selection: </span><span class="kc">null</span>

        <span class="nv">options:</span>
            <span class="nv">editable: </span><span class="kc">true</span>
            <span class="nv">plugins: </span><span class="p">{}</span>
            <span class="nv">floating: </span><span class="kc">true</span>
            <span class="nv">offset: </span><span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span><span class="nx">y</span><span class="o">:</span><span class="mi">0</span><span class="p">}</span>
            <span class="nv">showAlways: </span><span class="kc">false</span>
            <span class="nv">activated: </span><span class="o">-&gt;</span>
            <span class="nv">deactivated: </span><span class="o">-&gt;</span>
            <span class="nv">selected: </span><span class="o">-&gt;</span>
            <span class="nv">unselected: </span><span class="o">-&gt;</span>
            <span class="nv">enabled: </span><span class="o">-&gt;</span>
            <span class="nv">disabled: </span><span class="o">-&gt;</span>
            <span class="nv">placeholder: </span><span class="s1">&#39;&#39;</span>
            <span class="nv">parentElement: </span><span class="s1">&#39;body&#39;</span>

        <span class="nv">_create: </span><span class="o">-&gt;</span>
            <span class="vi">@originalContent = </span><span class="nx">@getContents</span><span class="p">()</span>
            <span class="vi">@id = </span><span class="nx">@_generateUUID</span><span class="p">()</span>
            <span class="nx">@_prepareToolbar</span><span class="p">()</span>

            <span class="k">for</span> <span class="nx">plugin</span><span class="p">,</span> <span class="nx">options</span> <span class="k">of</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">plugins</span>
                <span class="k">if</span> <span class="o">not</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">isPlainObject</span> <span class="nx">options</span>
                    <span class="nv">options = </span><span class="p">{}</span>
                <span class="nx">options</span><span class="p">[</span><span class="s2">&quot;editable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span>
                <span class="nx">options</span><span class="p">[</span><span class="s2">&quot;toolbar&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@toolbar</span>
                <span class="nx">options</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@id</span>
                <span class="nx">jQuery</span><span class="p">(</span><span class="nx">@element</span><span class="p">)[</span><span class="nx">plugin</span><span class="p">]</span> <span class="nx">options</span>

        <span class="nv">_init: </span><span class="o">-&gt;</span>
            <span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">editable</span>
                <span class="nx">@enable</span><span class="p">()</span>
            <span class="k">else</span>
                <span class="nx">@disable</span><span class="p">()</span></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><p>Disable an editable</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">disable: </span><span class="o">-&gt;</span>
            <span class="nx">@element</span><span class="p">.</span><span class="nx">attr</span> <span class="s2">&quot;contentEditable&quot;</span><span class="p">,</span> <span class="kc">false</span>
            <span class="nx">@element</span><span class="p">.</span><span class="nx">unbind</span> <span class="s2">&quot;focus&quot;</span><span class="p">,</span> <span class="nx">@_activated</span>
            <span class="nx">@element</span><span class="p">.</span><span class="nx">unbind</span> <span class="s2">&quot;blur&quot;</span><span class="p">,</span> <span class="nx">@_deactivated</span>
            <span class="nx">@element</span><span class="p">.</span><span class="nx">unbind</span> <span class="s2">&quot;keyup paste change&quot;</span><span class="p">,</span> <span class="nx">@_checkModified</span>
            <span class="nx">@element</span><span class="p">.</span><span class="nx">unbind</span> <span class="s2">&quot;keyup&quot;</span><span class="p">,</span> <span class="nx">@_keys</span>
            <span class="nx">@element</span><span class="p">.</span><span class="nx">unbind</span> <span class="s2">&quot;keyup mouseup&quot;</span><span class="p">,</span> <span class="nx">@_checkSelection</span>
            <span class="vi">@bound = </span><span class="kc">false</span>
            <span class="nx">@_trigger</span> <span class="s2">&quot;disabled&quot;</span><span class="p">,</span> <span class="kc">null</span></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><p>Enable an editable</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">enable: </span><span class="o">-&gt;</span>
            <span class="nx">@element</span><span class="p">.</span><span class="nx">attr</span> <span class="s2">&quot;contentEditable&quot;</span><span class="p">,</span> <span class="kc">true</span>

            <span class="nx">unless</span> <span class="nx">@element</span><span class="p">.</span><span class="nx">html</span><span class="p">()</span>
                <span class="nx">@element</span><span class="p">.</span><span class="nx">html</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">placeholder</span>

            <span class="k">if</span> <span class="o">not</span> <span class="nx">@bound</span>
                <span class="nx">@element</span><span class="p">.</span><span class="nx">bind</span> <span class="s2">&quot;focus&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">@_activated</span>
                <span class="nx">@element</span><span class="p">.</span><span class="nx">bind</span> <span class="s2">&quot;blur&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">@_deactivated</span>
                <span class="nx">@element</span><span class="p">.</span><span class="nx">bind</span> <span class="s2">&quot;keyup paste change&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">@_checkModified</span>
                <span class="nx">@element</span><span class="p">.</span><span class="nx">bind</span> <span class="s2">&quot;keyup&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">@_keys</span>
                <span class="nx">@element</span><span class="p">.</span><span class="nx">bind</span> <span class="s2">&quot;keyup mouseup&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">@_checkSelection</span>
                <span class="nv">widget = </span><span class="k">this</span>
                <span class="vi">@bound = </span><span class="kc">true</span>

            <span class="nx">@_trigger</span> <span class="s2">&quot;enabled&quot;</span><span class="p">,</span> <span class="kc">null</span></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><p>Activate an editable for editing</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">activate: </span><span class="o">-&gt;</span>
            <span class="nx">@element</span><span class="p">.</span><span class="nx">focus</span><span class="p">()</span></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><p>Only supports one range for now (i.e. no multiselection)</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">getSelection: </span><span class="o">-&gt;</span>
            <span class="k">if</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">browser</span><span class="p">.</span><span class="nx">msie</span>
                <span class="nv">range = </span><span class="nb">document</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">createRange</span><span class="p">()</span>
            <span class="k">else</span>
                <span class="k">if</span> <span class="nb">window</span><span class="p">.</span><span class="nx">getSelection</span>
                    <span class="nv">userSelection = </span><span class="nb">window</span><span class="p">.</span><span class="nx">getSelection</span><span class="p">()</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">selection</span><span class="p">)</span> <span class="c1">#opera</span>
                    <span class="nv">userSelection = </span><span class="nb">document</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">createRange</span><span class="p">()</span>
                <span class="k">else</span>
                    <span class="k">throw</span> <span class="s2">&quot;Your browser does not support selection handling&quot;</span>

                <span class="k">if</span> <span class="nx">userSelection</span><span class="p">.</span><span class="nx">rangeCount</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="nv">range = </span><span class="nx">userSelection</span><span class="p">.</span><span class="nx">getRangeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span>
                    <span class="nv">range = </span><span class="nx">userSelection</span>

            <span class="k">return</span> <span class="nx">range</span>

        <span class="nv">restoreSelection: </span><span class="nf">(range) -&gt;</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">browser</span><span class="p">.</span><span class="nx">msie</span> <span class="p">)</span>
                <span class="nx">range</span><span class="p">.</span><span class="nx">select</span><span class="p">()</span>
            <span class="k">else</span>
                <span class="nb">window</span><span class="p">.</span><span class="nx">getSelection</span><span class="p">().</span><span class="nx">removeAllRanges</span><span class="p">()</span>
                <span class="nb">window</span><span class="p">.</span><span class="nx">getSelection</span><span class="p">().</span><span class="nx">addRange</span><span class="p">(</span><span class="nx">range</span><span class="p">)</span>

        <span class="nv">replaceSelection: </span><span class="nf">(cb) -&gt;</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">browser</span><span class="p">.</span><span class="nx">msie</span> <span class="p">)</span>
                <span class="nv">t = </span><span class="nb">document</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">createRange</span><span class="p">().</span><span class="nx">text</span><span class="p">;</span>
                <span class="nv">r = </span><span class="nb">document</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">createRange</span><span class="p">()</span>
                <span class="nx">r</span><span class="p">.</span><span class="nx">pasteHTML</span><span class="p">(</span><span class="nx">cb</span><span class="p">(</span><span class="nx">t</span><span class="p">))</span>
            <span class="k">else</span>
                <span class="nv">sel = </span><span class="nb">window</span><span class="p">.</span><span class="nx">getSelection</span><span class="p">();</span>
                <span class="nv">range = </span><span class="nx">sel</span><span class="p">.</span><span class="nx">getRangeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
                <span class="nv">newTextNode = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createTextNode</span><span class="p">(</span><span class="nx">cb</span><span class="p">(</span><span class="nx">range</span><span class="p">.</span><span class="nx">extractContents</span><span class="p">()));</span>
                <span class="nx">range</span><span class="p">.</span><span class="nx">insertNode</span><span class="p">(</span><span class="nx">newTextNode</span><span class="p">);</span>
                <span class="nx">range</span><span class="p">.</span><span class="nx">setStartAfter</span><span class="p">(</span><span class="nx">newTextNode</span><span class="p">);</span>
                <span class="nx">sel</span><span class="p">.</span><span class="nx">removeAllRanges</span><span class="p">();</span>
                <span class="nx">sel</span><span class="p">.</span><span class="nx">addRange</span><span class="p">(</span><span class="nx">range</span><span class="p">);</span>

        <span class="nv">removeAllSelections: </span><span class="nf">() -&gt;</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">browser</span><span class="p">.</span><span class="nx">msie</span> <span class="p">)</span>
                <span class="nx">range</span><span class="p">.</span><span class="nx">empty</span><span class="p">()</span>
            <span class="k">else</span>
                <span class="nb">window</span><span class="p">.</span><span class="nx">getSelection</span><span class="p">().</span><span class="nx">removeAllRanges</span><span class="p">()</span></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><p>Get contents of an editable as HTML string</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">getContents: </span><span class="o">-&gt;</span>
           <span class="nx">@element</span><span class="p">.</span><span class="nx">html</span><span class="p">()</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><p>Set the contents of an editable</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">setContents: </span><span class="nf">(contents) -&gt;</span>
            <span class="nx">@element</span><span class="p">.</span><span class="nx">html</span> <span class="nx">contents</span></pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a href="#section-10" class="pilcrow">&#182;</a></div><p>Check whether the editable has been modified</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">isModified: </span><span class="o">-&gt;</span>
           <span class="nx">@originalContent</span> <span class="o">isnt</span> <span class="nx">@getContents</span><span class="p">()</span></pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a href="#section-11" class="pilcrow">&#182;</a></div><p>Set the editable as unmodified</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">setUnmodified: </span><span class="o">-&gt;</span>
           <span class="vi">@originalContent = </span><span class="nx">@getContents</span><span class="p">()</span></pre></div></td></tr><tr id="section-12"><td class="docs"><div class="pilwrap"><a href="#section-12" class="pilcrow">&#182;</a></div><p>Restore the content original</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">restoreOriginalContent: </span><span class="nf">() -&gt;</span>
            <span class="nx">@element</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">@originalContent</span><span class="p">)</span></pre></div></td></tr><tr id="section-13"><td class="docs"><div class="pilwrap"><a href="#section-13" class="pilcrow">&#182;</a></div><p>Execute a contentEditable command</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">execute: </span><span class="nf">(command, value) -&gt;</span>
            <span class="k">if</span> <span class="nb">document</span><span class="p">.</span><span class="nx">execCommand</span> <span class="nx">command</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">value</span>
                <span class="nx">@element</span><span class="p">.</span><span class="nx">trigger</span> <span class="s2">&quot;change&quot;</span>

        <span class="nv">_generateUUID: </span><span class="o">-&gt;</span>
            <span class="nv">S4 = </span><span class="o">-&gt;</span>
                <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">())</span> <span class="o">*</span> <span class="mh">0x10000</span><span class="o">|</span><span class="mi">0</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="nx">substring</span> <span class="mi">1</span>
            <span class="s2">&quot;#{S4()}#{S4()}-#{S4()}-#{S4()}-#{S4()}-#{S4()}#{S4()}#{S4()}&quot;</span>

        <span class="nv">_getToolbarPosition: </span><span class="nf">(event, selection) -&gt;</span>
            <span class="k">return</span> <span class="nx">unless</span> <span class="nx">event</span>
            <span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">floating</span>
                <span class="k">if</span> <span class="nx">event</span><span class="p">.</span><span class="nx">originalEvent</span> <span class="k">instanceof</span> <span class="nx">KeyboardEvent</span>
                   <span class="k">return</span> <span class="nx">@_getCaretPosition</span><span class="p">(</span><span class="nx">selection</span><span class="p">);</span>
                <span class="k">else</span> <span class="k">if</span> <span class="nx">event</span><span class="p">.</span><span class="nx">originalEvent</span> <span class="k">instanceof</span> <span class="nx">MouseEvent</span>
                    <span class="k">return</span> <span class="p">{</span> <span class="nv">top: </span><span class="nx">event</span><span class="p">.</span><span class="nx">pageY</span><span class="p">,</span> <span class="nv">left: </span><span class="nx">event</span><span class="p">.</span><span class="nx">pageX</span> <span class="p">}</span>
            <span class="k">else</span>
                <span class="nv">offset = </span><span class="nb">parseFloat</span><span class="p">(</span><span class="nx">@element</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;outline-width&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">@element</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;outline-offset&#39;</span><span class="p">))</span>
                <span class="nv">top: </span><span class="nx">@element</span><span class="p">.</span><span class="nx">offset</span><span class="p">().</span><span class="nx">top</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">toolbar</span><span class="p">.</span><span class="nx">outerHeight</span><span class="p">()</span> <span class="o">-</span> <span class="nx">offset</span>
                <span class="nv">left: </span><span class="nx">@element</span><span class="p">.</span><span class="nx">offset</span><span class="p">().</span><span class="nx">left</span> <span class="o">-</span> <span class="nx">offset</span>

        <span class="nv">_getCaretPosition: </span><span class="nf">(range) -&gt;</span>
            <span class="nv">tmpSpan = </span><span class="nx">jQuery</span> <span class="s2">&quot;&lt;span/&gt;&quot;</span>
            <span class="nv">newRange = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createRange</span><span class="p">()</span>
            <span class="nx">newRange</span><span class="p">.</span><span class="nx">setStart</span> <span class="nx">range</span><span class="p">.</span><span class="nx">endContainer</span><span class="p">,</span> <span class="nx">range</span><span class="p">.</span><span class="nx">endOffset</span>
            <span class="nx">newRange</span><span class="p">.</span><span class="nx">insertNode</span> <span class="nx">tmpSpan</span><span class="p">.</span><span class="nx">get</span> <span class="mi">0</span>

            <span class="nv">position = </span><span class="p">{</span><span class="nv">top: </span><span class="nx">tmpSpan</span><span class="p">.</span><span class="nx">offset</span><span class="p">().</span><span class="nx">top</span><span class="p">,</span> <span class="nv">left: </span><span class="nx">tmpSpan</span><span class="p">.</span><span class="nx">offset</span><span class="p">().</span><span class="nx">left</span><span class="p">}</span>
            <span class="nx">tmpSpan</span><span class="p">.</span><span class="nx">remove</span><span class="p">()</span>
            <span class="k">return</span> <span class="nx">position</span>

        <span class="nv">_bindToolbarEventsFixed: </span><span class="o">-&gt;</span>
            <span class="vi">@options.floating = </span><span class="kc">false</span></pre></div></td></tr><tr id="section-14"><td class="docs"><div class="pilwrap"><a href="#section-14" class="pilcrow">&#182;</a></div><p>catch activate -> show</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">@element</span><span class="p">.</span><span class="nx">bind</span> <span class="s2">&quot;halloactivated&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="nx">@_updateToolbarPosition</span> <span class="nx">@_getToolbarPosition</span> <span class="nx">event</span>
                <span class="nx">@toolbar</span><span class="p">.</span><span class="nx">show</span><span class="p">()</span></pre></div></td></tr><tr id="section-15"><td class="docs"><div class="pilwrap"><a href="#section-15" class="pilcrow">&#182;</a></div><p>catch deactivate -> hide</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">@element</span><span class="p">.</span><span class="nx">bind</span> <span class="s2">&quot;hallodeactivated&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="nx">@toolbar</span><span class="p">.</span><span class="nx">hide</span><span class="p">()</span>

        <span class="nv">_bindToolbarEventsRegular: </span><span class="o">-&gt;</span></pre></div></td></tr><tr id="section-16"><td class="docs"><div class="pilwrap"><a href="#section-16" class="pilcrow">&#182;</a></div><p>catch select -> show (and reposition?)</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">@element</span><span class="p">.</span><span class="nx">bind</span> <span class="s2">&quot;halloselected&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="nv">position = </span><span class="nx">@_getToolbarPosition</span> <span class="nx">data</span><span class="p">.</span><span class="nx">originalEvent</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">selection</span>
                <span class="k">return</span> <span class="nx">unless</span> <span class="nx">position</span>
                <span class="nx">@_updateToolbarPosition</span> <span class="nx">position</span>
                <span class="nx">@toolbar</span><span class="p">.</span><span class="nx">show</span><span class="p">()</span></pre></div></td></tr><tr id="section-17"><td class="docs"><div class="pilwrap"><a href="#section-17" class="pilcrow">&#182;</a></div><p>TO CHECK: Am I not showing in some case?</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-18"><td class="docs"><div class="pilwrap"><a href="#section-18" class="pilcrow">&#182;</a></div><p>catch deselect -> hide</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">@element</span><span class="p">.</span><span class="nx">bind</span> <span class="s2">&quot;hallounselected&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="nx">@toolbar</span><span class="p">.</span><span class="nx">hide</span><span class="p">()</span>

            <span class="nx">@element</span><span class="p">.</span><span class="nx">bind</span> <span class="s2">&quot;hallodeactivated&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="nx">@toolbar</span><span class="p">.</span><span class="nx">hide</span><span class="p">()</span>

        <span class="nv">_prepareToolbar: </span><span class="o">-&gt;</span>
            <span class="vi">@toolbar = </span><span class="nx">jQuery</span><span class="p">(</span><span class="s1">&#39;&lt;div class=&quot;hallotoolbar&quot;&gt;&lt;/div&gt;&#39;</span><span class="p">).</span><span class="nx">hide</span><span class="p">()</span>
            <span class="nx">@toolbar</span><span class="p">.</span><span class="nx">css</span> <span class="s2">&quot;position&quot;</span><span class="p">,</span> <span class="s2">&quot;absolute&quot;</span>
            <span class="nx">@toolbar</span><span class="p">.</span><span class="nx">css</span> <span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="nx">@element</span><span class="p">.</span><span class="nx">offset</span><span class="p">().</span><span class="nx">top</span> <span class="o">-</span> <span class="mi">20</span>
            <span class="nx">@toolbar</span><span class="p">.</span><span class="nx">css</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="nx">@element</span><span class="p">.</span><span class="nx">offset</span><span class="p">().</span><span class="nx">left</span>
            <span class="nx">jQuery</span><span class="p">(</span><span class="nx">@options</span><span class="p">.</span><span class="nx">parentElement</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">@toolbar</span><span class="p">)</span>

            <span class="nx">@toolbar</span><span class="p">.</span><span class="nx">bind</span> <span class="s2">&quot;mousedown&quot;</span><span class="p">,</span> <span class="nf">(event) -&gt;</span>
                <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>

            <span class="nx">@_bindToolbarEventsFixed</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">showAlways</span>
            <span class="nx">@_bindToolbarEventsRegular</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">showAlways</span>

            <span class="nx">jQuery</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">resize</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="nx">@_updateToolbarPosition</span> <span class="nx">@_getToolbarPosition</span> <span class="nx">event</span>

        <span class="nv">_updateToolbarPosition: </span><span class="nf">(position) -&gt;</span>
            <span class="k">return</span> <span class="nx">unless</span> <span class="nx">position</span><span class="p">.</span><span class="nx">top</span> <span class="o">and</span> <span class="nx">position</span><span class="p">.</span><span class="nx">left</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">toolbar</span><span class="p">.</span><span class="nx">css</span> <span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="nx">position</span><span class="p">.</span><span class="nx">top</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">toolbar</span><span class="p">.</span><span class="nx">css</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="nx">position</span><span class="p">.</span><span class="nx">left</span>

        <span class="nv">_checkModified: </span><span class="nf">(event) -&gt;</span>
            <span class="nv">widget = </span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span>
            <span class="k">if</span> <span class="nx">widget</span><span class="p">.</span><span class="nx">isModified</span><span class="p">()</span>
                <span class="nx">widget</span><span class="p">.</span><span class="nx">_trigger</span> <span class="s2">&quot;modified&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span>
                    <span class="nv">editable: </span><span class="nx">widget</span>
                    <span class="nv">content: </span><span class="nx">widget</span><span class="p">.</span><span class="nx">getContents</span><span class="p">()</span>

        <span class="nv">_keys: </span><span class="nf">(event) -&gt;</span>
            <span class="nv">widget = </span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span>
            <span class="k">if</span> <span class="nx">event</span><span class="p">.</span><span class="nx">keyCode</span> <span class="o">==</span> <span class="mi">27</span>
                <span class="nv">old = </span><span class="nx">widget</span><span class="p">.</span><span class="nx">getContents</span><span class="p">()</span>
                <span class="nx">widget</span><span class="p">.</span><span class="nx">restoreOriginalContent</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span>
                <span class="nx">widget</span><span class="p">.</span><span class="nx">_trigger</span> <span class="s2">&quot;restored&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span>
                    <span class="nv">editable: </span><span class="nx">widget</span>
                    <span class="nv">content: </span><span class="nx">widget</span><span class="p">.</span><span class="nx">getContents</span><span class="p">()</span>
                    <span class="nv">thrown: </span><span class="nx">old</span>

                <span class="nx">widget</span><span class="p">.</span><span class="nx">turnOff</span><span class="p">()</span>

        <span class="nv">_rangesEqual: </span><span class="nf">(r1, r2) -&gt;</span>
            <span class="nx">r1</span><span class="p">.</span><span class="nx">startContainer</span> <span class="o">is</span> <span class="nx">r2</span><span class="p">.</span><span class="nx">startContainer</span> <span class="o">and</span> <span class="nx">r1</span><span class="p">.</span><span class="nx">startOffset</span> <span class="o">is</span> <span class="nx">r2</span><span class="p">.</span><span class="nx">startOffset</span> <span class="o">and</span> <span class="nx">r1</span><span class="p">.</span><span class="nx">endContainer</span> <span class="o">is</span> <span class="nx">r2</span><span class="p">.</span><span class="nx">endContainer</span> <span class="o">and</span> <span class="nx">r1</span><span class="p">.</span><span class="nx">endOffset</span> <span class="o">is</span> <span class="nx">r2</span><span class="p">.</span><span class="nx">endOffset</span></pre></div></td></tr><tr id="section-19"><td class="docs"><div class="pilwrap"><a href="#section-19" class="pilcrow">&#182;</a></div><p>Check if some text is selected, and if this selection has changed. If it changed,
trigger the "halloselected" event</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">_checkSelection: </span><span class="nf">(event) -&gt;</span>
            <span class="k">if</span> <span class="nx">event</span><span class="p">.</span><span class="nx">keyCode</span> <span class="o">==</span> <span class="mi">27</span>
                <span class="k">return</span>

            <span class="nv">widget = </span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span></pre></div></td></tr><tr id="section-20"><td class="docs"><div class="pilwrap"><a href="#section-20" class="pilcrow">&#182;</a></div><p>The mouseup event triggers before the text selection is updated.
I did not find a better solution than setTimeout in 0 ms</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">setTimeout</span> <span class="nf">()-&gt;</span>
                <span class="nv">sel = </span><span class="nx">widget</span><span class="p">.</span><span class="nx">getSelection</span><span class="p">()</span>
                <span class="k">if</span> <span class="nx">widget</span><span class="p">.</span><span class="nx">_isEmptySelection</span><span class="p">(</span><span class="nx">sel</span><span class="p">)</span> <span class="o">or</span> <span class="nx">widget</span><span class="p">.</span><span class="nx">_isEmptyRange</span><span class="p">(</span><span class="nx">sel</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nx">widget</span><span class="p">.</span><span class="nx">selection</span>
                        <span class="nv">widget.selection = </span><span class="kc">null</span>
                        <span class="nx">widget</span><span class="p">.</span><span class="nx">_trigger</span> <span class="s2">&quot;unselected&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span>
                            <span class="nv">editable: </span><span class="nx">widget</span>
                            <span class="nv">originalEvent: </span><span class="nx">event</span>
                    <span class="k">return</span>

                <span class="k">if</span> <span class="o">!</span><span class="nx">widget</span><span class="p">.</span><span class="nx">selection</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">widget</span><span class="p">.</span><span class="nx">_rangesEqual</span> <span class="nx">sel</span><span class="p">,</span> <span class="nx">widget</span><span class="p">.</span><span class="nx">selection</span>
                    <span class="nv">widget.selection = </span><span class="nx">sel</span><span class="p">.</span><span class="nx">cloneRange</span><span class="p">();</span>
                    <span class="nx">widget</span><span class="p">.</span><span class="nx">_trigger</span> <span class="s2">&quot;selected&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span>
                        <span class="nv">editable: </span><span class="nx">widget</span>
                        <span class="nv">selection: </span><span class="nx">widget</span><span class="p">.</span><span class="nx">selection</span>
                        <span class="nv">ranges: </span><span class="p">[</span><span class="nx">widget</span><span class="p">.</span><span class="nx">selection</span><span class="p">]</span>
                        <span class="nv">originalEvent: </span><span class="nx">event</span>
            <span class="p">,</span> <span class="mi">0</span>

        <span class="nv">_isEmptySelection: </span><span class="nf">(selection) -&gt;</span>
            <span class="k">if</span> <span class="nx">selection</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;Caret&quot;</span>
                <span class="k">return</span> <span class="kc">true</span>

            <span class="k">return</span> <span class="kc">false</span>

        <span class="nv">_isEmptyRange: </span><span class="nf">(range) -&gt;</span>
            <span class="k">if</span> <span class="nx">range</span><span class="p">.</span><span class="nx">collapsed</span>
                <span class="k">return</span> <span class="kc">true</span>
            <span class="k">if</span> <span class="nx">range</span><span class="p">.</span><span class="nx">isCollapsed</span>
                <span class="k">return</span> <span class="nx">range</span><span class="p">.</span><span class="nx">isCollapsed</span><span class="p">()</span>

            <span class="k">return</span> <span class="kc">false</span>

        <span class="nv">turnOn: </span><span class="nf">() -&gt;</span>
            <span class="k">if</span> <span class="k">this</span><span class="p">.</span><span class="nx">getContents</span><span class="p">()</span> <span class="o">is</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">placeholder</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">setContents</span> <span class="s1">&#39;&#39;</span>

            <span class="nx">jQuery</span><span class="p">(</span><span class="nx">@element</span><span class="p">).</span><span class="nx">addClass</span> <span class="s1">&#39;inEditMode&#39;</span></pre></div></td></tr><tr id="section-21"><td class="docs"><div class="pilwrap"><a href="#section-21" class="pilcrow">&#182;</a></div><p>make sure the toolbar has not got the full width of the editable element when floating is set to true</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="o">!</span><span class="nx">@options</span><span class="p">.</span><span class="nx">floating</span>
                <span class="nv">el = </span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">@element</span><span class="p">)</span>
                <span class="nv">widthToAdd = </span><span class="nb">parseFloat</span> <span class="nx">el</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;padding-left&#39;</span><span class="p">)</span>
                <span class="nx">widthToAdd</span> <span class="o">+=</span> <span class="nb">parseFloat</span> <span class="nx">el</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;padding-right&#39;</span><span class="p">)</span>
                <span class="nx">widthToAdd</span> <span class="o">+=</span> <span class="nb">parseFloat</span> <span class="nx">el</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;border-left-width&#39;</span><span class="p">)</span>
                <span class="nx">widthToAdd</span> <span class="o">+=</span> <span class="nb">parseFloat</span> <span class="nx">el</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;border-right-width&#39;</span><span class="p">)</span>
                <span class="nx">widthToAdd</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">parseFloat</span> <span class="nx">el</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;outline-width&#39;</span><span class="p">))</span> <span class="o">*</span> <span class="mi">2</span>
                <span class="nx">widthToAdd</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">parseFloat</span> <span class="nx">el</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;outline-offset&#39;</span><span class="p">))</span> <span class="o">*</span> <span class="mi">2</span>
                <span class="nx">jQuery</span><span class="p">(</span><span class="nx">@toolbar</span><span class="p">).</span><span class="nx">css</span> <span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="nx">el</span><span class="p">.</span><span class="nx">width</span><span class="p">()</span><span class="o">+</span><span class="nx">widthToAdd</span>
            <span class="k">else</span>
                <span class="nx">@toolbar</span><span class="p">.</span><span class="nx">css</span> <span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="s2">&quot;auto&quot;</span>
            <span class="nx">@_trigger</span> <span class="s2">&quot;activated&quot;</span><span class="p">,</span> <span class="err">@</span>

        <span class="nv">turnOff: </span><span class="nf">() -&gt;</span>
            <span class="nx">jQuery</span><span class="p">(</span><span class="nx">@element</span><span class="p">).</span><span class="nx">removeClass</span> <span class="s1">&#39;inEditMode&#39;</span>
            <span class="nx">@_trigger</span> <span class="s2">&quot;deactivated&quot;</span><span class="p">,</span> <span class="err">@</span>

            <span class="nx">unless</span> <span class="nx">@getContents</span><span class="p">()</span>
                <span class="nx">@setContents</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">placeholder</span>

        <span class="nv">_activated: </span><span class="nf">(event) -&gt;</span>
            <span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">turnOn</span><span class="p">()</span>

        <span class="nv">_deactivated: </span><span class="nf">(event) -&gt;</span>
            <span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">turnOff</span><span class="p">()</span>


<span class="p">)(</span><span class="nx">jQuery</span><span class="p">)</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Tue Mar 27 2012 14:05:36 GMT+0200 (CEST)  </div><div id="projectname"><a href="../index.html">Hallo Editor</a></div></div></body></html>